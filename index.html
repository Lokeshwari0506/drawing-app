<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Draw and Save</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #333;
    }
    canvas {
      border: 2px solid #555;
      border-radius: 8px;
      background: #fff;
      touch-action: none;
      margin-top: 10px;
    }
    select, button, input[type="color"], input[type="file"], input[type="range"] {
      padding: 6px;
      margin: 4px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
    }
    select, input[type="color"], input[type="range"] {
      background: #fff;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      color: #fff;
    }
    #saveBtn { background: #28a745; }
    #clearBtn { background: #dc3545; }
    #eraserBtn { background: #ff9800; }
    #pencilBtn { background: #007bff; }
    #uploadBtn { background: #6f42c1; }
    #toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>üé® Draw & Save Your Emotion</h2>
  <p style="max-width: 500px; text-align: center;">
    Select your emotion, choose a tool (pencil/eraser), and draw!  
    You can also upload an existing image or paste one from your clipboard.
  </p>

  <label>Emotion:
    <select id="emotion">
      <option value="happy">Happy</option>
      <option value="sad">Sad</option>
      <option value="angry">Angry</option>
      <option value="calm">Calm</option>
      <option value="disgust">Disgust</option>
      <option value="vibing">Vibing</option>
      <option value="fear">Fear</option>
      <option value="disappointment">Disappointment</option>
      <option value="excitement">Excitement</option>
    </select>
  </label>

  <div id="toolbar">
    <button id="pencilBtn">‚úè Pencil</button>
    <button id="eraserBtn">ü©π Eraser</button>
    <label>Color: <input type="color" id="colorPicker" value="#000000"></label>
    <label>Size: <input type="range" id="sizePicker" min="1" max="20" value="3"></label>
    <input type="file" id="imageUpload" accept="image/*" hidden>
    <button id="uploadBtn">üì§ Upload Image</button>
    <button id="clearBtn">üóë Clear</button>
    <button id="saveBtn">üíæ Save</button>
  </div>

  <canvas id="canvas" width="320" height="320"></canvas>

<script>
  // ---------- CONFIG ----------
  const SUPABASE_URL = "https://xhdrrqfwcmrmzdbjcaae.supabase.co";   
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhoZHJycWZ3Y21ybXpkYmpjYWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3OTQ4NTYsImV4cCI6MjA3MDM3MDg1Nn0.ubdlVgx2MCMmiWLz8pKbNmSSESp9NGhTpwPZeFvMVuw"; // <-- replace
  const BUCKET = "drawing-emotion";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- Canvas Setup ----------
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let painting = false;
  let tool = 'pencil';
  let color = document.getElementById('colorPicker').value;
  let size = document.getElementById('sizePicker').value;

  function startPosition(e) {
    painting = true;
    ctx.beginPath();
    ctx.moveTo(getX(e), getY(e));
  }
  function draw(e) {
    if (!painting) return;
    ctx.lineTo(getX(e), getY(e));
    ctx.strokeStyle = (tool === 'pencil') ? color : '#fff';
    ctx.lineWidth = size;
    ctx.lineCap = 'round';
    ctx.stroke();
  }
  function endPosition() {
    painting = false;
    ctx.beginPath();
  }
  function getX(e) {
    return (e.touches ? e.touches[0].clientX : e.clientX) - canvas.getBoundingClientRect().left;
  }
  function getY(e) {
    return (e.touches ? e.touches[0].clientY : e.clientY) - canvas.getBoundingClientRect().top;
  }

  // Event Listeners for Drawing
  canvas.addEventListener('mousedown', startPosition);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', endPosition);
  canvas.addEventListener('mouseout', endPosition);
  canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPosition(e); });
  canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
  canvas.addEventListener('touchend', (e) => { e.preventDefault(); endPosition(); });

  // Tool Buttons
  document.getElementById('pencilBtn').onclick = () => { tool = 'pencil'; };
  document.getElementById('eraserBtn').onclick = () => { tool = 'eraser'; };
  document.getElementById('colorPicker').oninput = (e) => { color = e.target.value; };
  document.getElementById('sizePicker').oninput = (e) => { size = e.target.value; };

  // Clear Canvas
  document.getElementById('clearBtn').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Upload Image
  document.getElementById('uploadBtn').onclick = () => document.getElementById('imageUpload').click();
  document.getElementById('imageUpload').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
    img.src = URL.createObjectURL(file);
  };

  // Paste from Clipboard
  window.addEventListener('paste', (e) => {
    const items = e.clipboardData.items;
    for (let item of items) {
      if (item.type.indexOf('image') !== -1) {
        const file = item.getAsFile();
        const img = new Image();
        img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
        img.src = URL.createObjectURL(file);
      }
    }
  });

  // ---------- Save to Supabase ----------
  async function saveDrawing() {
    const emotion = document.getElementById('emotion').value;
    const { data: insertData, error: insertErr } = await supabaseClient
      .from('drawings')
      .insert({ emotion })
      .select()
      .single();

    if (insertErr) { alert('DB insert failed: ' + insertErr.message); return; }

    const id = insertData.id;
    const filename = `${emotion}_${id}.png`;
    const dataUrl = canvas.toDataURL('image/png');
    const blob = await (await fetch(dataUrl)).blob();

    const { error: uploadErr } = await supabaseClient.storage
      .from(BUCKET)
      .upload(filename, blob, { contentType: 'image/jpeg' });

    if (uploadErr) { alert('Upload failed: ' + uploadErr.message); return; }

    await supabaseClient.from('drawings').update({ filename }).eq('id', id);
    alert('Saved as ' + filename);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  document.getElementById('saveBtn').addEventListener('click', saveDrawing);
</script>
</body>
</html>
